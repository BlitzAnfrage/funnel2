<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <title>Mobile Bewerbungsfunnel ‚Äì Handwerk (Vorlage v4)</title>
  <!-- Modern Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700;800;900&display=swap" rel="stylesheet">
  <!--
  =====================================================================================
  VORLAGE V4 ‚Äì Dark default, Toggle mit animiertem Moon-Knob, Emoji-Benefits, Dropdown
  Neu: Autofokus (Kontakt-Name), Retry (POST x3), Lazy/Async-Bilder, Microcopy 24h
  =====================================================================================
  -->
  <style>
    :root { /* LIGHT THEME VARS */
      --bg: #ffffff;
      --card: #f8fafc;
      --text: #0f172a;
      --muted: #475569;
      --primary: #62bb47; /* Branding Prim√§r */
      --accent: #0ea5e9;
      --ring: rgba(14,165,233,.28);
      --danger: #ef4444;
      --ok: #16a34a;
      --shadow: 0 10px 32px rgba(2,6,23,.08);
      --stroke: color-mix(in oklab, var(--muted) 18%, transparent);
    }
    [data-theme="dark"] {
      --bg: #0b1220;
      --card: #111827;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --ring: rgba(99,102,241,.35);
      --shadow: 0 10px 32px rgba(0,0,0,.35);
      --stroke: color-mix(in oklab, var(--muted) 22%, transparent);
    }

    *, *::before, *::after { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: var(--bg); color: var(--text); line-height: 1.5; font-size: 16px;
    }
    .wrap { max-width: 520px; margin: 0 auto; padding: 8px 14px 28px; }

    header { position: sticky; top: 0; z-index: 50; backdrop-filter: saturate(1.15) blur(10px); background: color-mix(in oklab, var(--bg) 85%, transparent); border-bottom: 1px solid var(--stroke); }
    .topbar { display:flex; align-items:center; justify-content:center; gap:10px; padding: 12px 8px; }
    .logo { height: 44px; width: auto; display:block; border-radius: 10px; }
    .logo-placeholder { width: 44px; height: 44px; border-radius: 12px; background: var(--card); display:grid; place-items:center; color: var(--muted); font-weight: 900; box-shadow: var(--shadow); border:1px solid var(--stroke); }
    .actions { position:absolute; right:12px; top:10px; display:flex; gap:8px; align-items:center; }

    /* Toggle: normal switch mit animiertem Moon-Knob */
    .toggle { width: 60px; height: 32px; border-radius: 999px; border:1px solid var(--stroke); background: color-mix(in oklab, var(--card) 92%, transparent); position: relative; cursor: pointer; box-shadow: var(--shadow); transition: background .2s ease, border-color .2s ease; display:flex; align-items:center; }
    .toggle .knob { width: 26px; height: 26px; border-radius: 999px; background: var(--text); position: absolute; left: 3px; top: 3px; transition: transform .22s ease, background .22s ease; display:grid; place-items:center; overflow:hidden; }
    .toggle[data-on="true"] .knob { transform: translateX(28px) rotate(25deg); }
    .moon { width: 14px; height: 14px; background: #fff; border-radius:50%; position: relative; transition: transform .35s ease; }
    .moon::after { content:""; position:absolute; width: 14px; height: 14px; background: var(--text); border-radius:50%; top: -2px; left: 4px; }
    .toggle[data-on="true"] .moon { transform: rotate(25deg); }

    .progress { height: 8px; background: color-mix(in oklab, var(--muted) 12%, transparent); border-radius: 999px; overflow: hidden; margin: 0 12px 10px; }
    .bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--primary), var(--accent)); transition: width .3s ease; }

    .card { background: var(--card); border:1px solid var(--stroke); border-radius: 18px; padding: 18px; margin: 12px 8px; box-shadow: var(--shadow); }
    .hidden { display:none !important; }

    h1, h2, h3 { margin: 0 0 8px; font-weight: 900; letter-spacing:.1px; }
    .title { font-size: 1.5rem; }
    .subtitle { color: var(--muted); font-size: .98rem; font-weight: 600; }

    .hero { display:grid; gap:14px; text-align:center; }
    .pill { display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius: 999px; background: color-mix(in oklab, var(--primary) 18%, transparent); border:1px solid color-mix(in oklab, var(--primary) 36%, transparent); font-size:.82rem; font-weight:800; }

    .btn { appearance:none; border:none; background: linear-gradient(90deg, var(--primary), var(--accent)); color: #fff; padding: 16px 16px; width: 100%; border-radius: 14px; font-weight: 900; letter-spacing: .3px; cursor:pointer; box-shadow: var(--shadow); font-size: 1rem; }
    .btn:disabled { opacity: .7; cursor:not-allowed; }
    .btn:active { transform: translateY(1px); }

    .grid { display:grid; gap:12px; }

    /* Segmented / chips */
    .seg { display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; }
    .chip { border:1px solid var(--stroke); background: color-mix(in oklab, var(--card) 85%, transparent); border-radius: 14px; padding: 12px 10px; text-align:center; cursor:pointer; user-select:none; font-weight:800; transition: transform .08s ease, outline .2s; }
    .chip:active { transform: translateY(1px); }
    .chip.active { outline:3px solid var(--ring); border-color: transparent; }

    .yn { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }

    /* Floating labels */
    .fcontrol { position: relative; }
    .finput { width: 100%; padding: 20px 14px 12px; border-radius: 14px; border:1px solid var(--stroke); background: color-mix(in oklab, var(--card) 90%, transparent); color: var(--text); font-size: 16px; outline: none; font-weight: 700; }
    .finput:focus { outline: 4px solid var(--ring); border-color: transparent; }
    .flabel { position:absolute; left:12px; top:12px; padding:0 4px; color: var(--muted); pointer-events:none; transition: all .15s ease; font-weight: 700; background: transparent; }
    .finput::placeholder{ color: transparent; }
    .finput:focus + .flabel, .finput:not(:placeholder-shown) + .flabel { top:5px; font-size: 12px; opacity:.85; }
    .err { color: var(--danger); font-size:.9rem; font-weight: 800; }

    .mini { font-size: .86rem; color: var(--muted); font-weight:700; }
    .divider { height:1px; background: var(--stroke); margin: 10px 0; border-radius: 999px; }

    /* Accordion (Dropdown) */
    .accordion { border:1px solid var(--stroke); border-radius: 14px; background: color-mix(in oklab, var(--card) 96%, transparent); overflow:hidden; }
    .accordion summary { list-style:none; cursor:pointer; padding:12px 14px; font-weight:900; display:flex; align-items:center; justify-content:space-between; }
    .accordion summary::-webkit-details-marker { display: none; }
    .accordion .chev { width: 18px; height: 18px; border-right: 2px solid var(--muted); border-bottom: 2px solid var(--muted); transform: rotate(-45deg); transition: transform .2s ease; }
    .accordion[open] .chev { transform: rotate(135deg); }
    .accordion-body { padding: 12px 14px 16px; display:grid; gap:14px; line-height:1.6; }
    .bullet { display:flex; gap:10px; align-items:flex-start; }
    .bullet i { font-style: normal; font-weight:900; }

    /* Vorteile & √úber uns (nicht sticky, damit nichts √ºberlappt) */
    .sticky-info { position: static; bottom: auto; z-index: auto; padding: 0; margin: 12px 8px; }
    .info-card { background: color-mix(in oklab, var(--card) 96%, transparent); border:1px dashed var(--stroke); border-radius: 16px; padding:14px; display:grid; gap:12px; }

    /* Benefit list modern with emoji */
    .benefit-list { list-style: none; padding:0; margin:0; display:grid; gap:10px; }
    .benefit { display:grid; gap:4px; padding:10px; border:1px solid color-mix(in oklab, var(--primary) 26%, transparent); border-radius: 14px; background: color-mix(in oklab, var(--primary) 10%, transparent); }
    .benefit-title { font-weight: 900; display:flex; align-items:center; gap:8px; }
    .benefit-desc { font-size:.86rem; color: var(--muted); font-weight:700; }

    /* About modern */
    .about { display:grid; grid-template-columns: 44px 1fr; gap:10px; align-items:center; }
    .about-logo { width:44px; height:44px; border-radius:12px; border:1px solid var(--stroke); background: color-mix(in oklab, var(--card) 80%, transparent); display:grid; place-items:center; font-weight:900; color: var(--muted); overflow:hidden; }
    .about-title { font-weight: 900; }

    footer { text-align:center; font-size:.85rem; color:var(--muted); padding:8px 12px 24px; }
    footer a { color: inherit; text-decoration: underline; }
  </style>
</head>
<body data-theme="dark">
  <div class="wrap">
    <header>
      <div class="topbar">
        <div id="logoSlot" aria-label="Logo" title="Logo" class="logo-placeholder">LOGO</div>
        <div class="actions">
          <div id="themeToggle" class="toggle" role="switch" aria-checked="true" tabindex="0">
            <div class="knob"><div class="moon" aria-hidden="true"></div></div>
          </div>
        </div>
      </div>
      <div class="progress" aria-hidden="true"><div class="bar" id="progressBar"></div></div>
    </header>

    <!-- STEP 1: INTRO -->
    <section class="card step" data-step="1">
      <div class="hero">
        <span class="pill" id="companyPill">Handwerk im Saar‚ÄëPfalz‚ÄëRaum</span>
        <h1 class="title" id="jobTitle">Anlagenmechaniker SHK (m/w/d)</h1>
        <p class="subtitle" id="heroSubtitle">60 Sekunden. Keine Unterlagen. Wir melden uns telefonisch.</p>
        <img id="heroImage" alt="Platzhalter Bild" loading="lazy" decoding="async" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='720' height='320'%3E%3Crect width='100%25' height='100%25' fill='%23111827'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%239ca3af' font-family='Inter' font-size='18'%3EHero Placeholder%3C/text%3E%3C/svg%3E" style="width:100%; border-radius: 14px; border:1px solid var(--stroke);" />
        <button class="btn" id="startBtn">Jetzt starten</button>
        <p class="mini">Dauer: ca. 60 Sekunden</p>
      </div>
    </section>

    <!-- STEP 2: QUALIFIKATIONEN (dynamic) -->
    <section class="card step hidden" data-step="2">
      <h2 class="title">Kurze Fragen</h2>
      <p class="subtitle">Damit wir dich richtig einordnen k√∂nnen.</p>
      <div id="questions" class="grid" aria-live="polite"></div>
      <div id="qError" class="err hidden">Bitte alle Pflichtfragen beantworten.</div>
      <button class="btn" id="toContact">Weiter</button>
    </section>

    <!-- STEP 3: KONTAKT -->
    <section class="card step hidden" data-step="3">
      <h2 class="title">Wie erreichen wir dich?</h2>
      <div class="grid">
        <div class="fcontrol">
          <input id="name" class="finput" type="text" required placeholder=" " autocomplete="name" />
          <label for="name" class="flabel">Dein Name *</label>
        </div>
        <div class="fcontrol">
          <input id="phone" class="finput" type="tel" required placeholder=" " autocomplete="tel" inputmode="tel" />
          <label for="phone" class="flabel">Telefon *</label>
        </div>
        <div class="fcontrol">
          <input id="email" class="finput" type="email" required placeholder=" " autocomplete="email" />
          <label for="email" class="flabel">E‚ÄëMail *</label>
        </div>
        <label class="mini"><input id="consent" type="checkbox" /> Ich stimme der Verarbeitung meiner Daten zum Zweck der Bewerbung zu.</label>
      </div>
      <div class="divider"></div>
      <button class="btn" id="submitBtn">Bewerbung absenden</button>
      <p class="mini" style="margin-top:8px">Kein Upload n√∂tig ‚Äì wir rufen dich an.</p>
      <p class="mini">Wir melden uns werktags meist innerhalb von 24h.</p>
      <div id="formError" class="err hidden" role="alert">Bitte f√ºlle alle Felder korrekt aus und akzeptiere die Einwilligung.</div>
    </section>

    <!-- STEP 4: BEST√ÑTIGUNG -->
    <section class="card step hidden" data-step="4">
      <h2 class="title">Danke ‚Äì Bewerbung eingegangen!</h2>
      <p class="subtitle">Wir melden uns in K√ºrze telefonisch. Bitte achte auf unbekannte Nummern.</p>
      <div class="grid" style="margin-top:6px">
        <div class="info-card">‚úÖ Deine Angaben wurden sicher √ºbertragen.</div>
        <button class="btn" id="finishBtn">Zur Startseite</button>
      </div>
    </section>

    <!-- DROPDOWN: Kurzinfo zur Stelle & Ablauf -->
    <section class="card">
      <details class="accordion" id="summaryBox">
        <summary>
          <span id="summaryTitle">Kurzinfo zur Stelle & Ablauf</span>
          <i class="chev"></i>
        </summary>
        <div class="accordion-body" id="summaryBody">
          <!-- Dynamisch aus cfg.summary.* gef√ºllt -->
        </div>
      </details>
    </section>

    <!-- Vorteile + √úber uns (sichtbar unterhalb) -->
    <div class="sticky-info">
      <div class="info-card">
        <ul class="benefit-list" id="benefitsList"></ul>
        <div class="divider"></div>
        <div class="about">
          <div id="aboutLogo" class="about-logo">LOGO</div>
          <div>
            <div class="about-title" id="aboutTitle">√úber uns</div>
            <div class="mini" id="aboutText">Bodenst√§ndig, zuverl√§ssig, modern organisiert. Kurze Wege ‚Äì Saar‚ÄëPfalz.</div>
          </div>
        </div>
      </div>
    </div>

    <footer>
      <span id="companyNameFoot">Muster Bau GmbH</span> ¬∑
      <a id="privacyLink" href="#" target="_blank" rel="noopener">Datenschutz</a> ¬∑
      <a id="imprintLink" href="#" target="_blank" rel="noopener">Impressum</a>
    </footer>
  </div>

  <!-- =================== CONFIG (ANPASSEN) =================== -->
  <script type="application/json" id="funnel-config">
  {
    "company": {
      "name": "Muster Bau GmbH",
      "logo": "",
      "tagline": "Handwerk im Saar‚ÄëPfalz‚ÄëRaum",
      "about": "Bodenst√§ndig, zuverl√§ssig, modern organisiert. Kurze Wege ‚Äì Saar‚ÄëPfalz. Mehr als 20 Mitarbeitende, feste Touren, saubere Baustellen."
    },
    "job": { "title": "Anlagenmechaniker SHK (m/w/d)", "alias": "SHK‚ÄëAnlagenmechaniker" },
    "theme": { "primary": "#62bb47", "accent": "#0ea5e9" },
    "questions": [
      { "id": "exp_role",   "label": "Hast du bereits Erfahrungen als {{job.alias}}?", "type": "yesno", "required": true },
      { "id": "years",      "label": "Wie viele Jahre Berufserfahrung hast du?",       "type": "select", "options": ["0‚Äì1", "2‚Äì4", "5+"], "required": true },
      { "id": "license_b",  "label": "Hast du einen PKW‚ÄëF√ºhrerschein (Klasse B)?",     "type": "yesno", "required": true },
      { "id": "custom",     "label": "Individuelle Frage (vom Prompt anpassbar)",        "type": "text",  "required": false }
    ],
    "benefits": [
      { "icon": "üí∂", "title": "√úbertarifliche Bezahlung", "desc": "Leistungsgerecht und p√ºnktlich ‚Äì plus Extras." },
      { "icon": "üè†", "title": "Regionale Eins√§tze",       "desc": "Saar & Pfalz ‚Äì abends zu Hause, keine Montage." },
      { "icon": "üöê", "title": "Moderner Fuhrpark",         "desc": "Saubere Fahrzeuge, gutes Werkzeug, neue Maschinen." }
    ],
    "summary": {
      "title": "Kurzinfo zur Stelle & Ablauf",
      "aboutRole": [
        "üìå Einsatzgebiet: Saar-Pfalz, keine Fernmontage",
        "üõ†Ô∏è Aufgaben: Wartung, Installation, Kundendienst (je nach Erfahrung)",
        "‚è∞ Arbeitszeit: Vollzeit, geregelte Zeiten"
      ],
      "process": [
        "1) 60 Sek. Formular ausf√ºllen",
        "2) Wir rufen dich an (gleicher/folgender Werktag)",
        "3) Kurzes Kennenlernen vor Ort/Video"
      ]
    },
    "n8n": { "webhook_url": "https://example.com/webhook/REPLACE_ME", "funnel_id": "handwerk-funnel-v4" },
    "legal": { "privacy_url": "#", "imprint_url": "#" }
  }
  </script>

  <!-- ================ FUNNEL LOGIK ================ -->
  <script>
  (function(){
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    // Load config
    const cfg = JSON.parse(document.getElementById('funnel-config').textContent);

    // Apply theme vars
    document.documentElement.style.setProperty('--primary', cfg.theme?.primary || '#62bb47');
    document.documentElement.style.setProperty('--accent',  cfg.theme?.accent  || '#0ea5e9');

    // Theme: default dark; allow saved override
    const saved = localStorage.getItem('theme');
    const isDark = saved ? saved === 'dark' : true;
    document.body.setAttribute('data-theme', isDark ? 'dark' : 'light');
    const toggle = $('#themeToggle');
    const setToggle = (on) => {
      toggle.dataset.on = on ? 'true' : 'false';
      toggle.setAttribute('aria-checked', on ? 'true' : 'false');
      document.body.setAttribute('data-theme', on ? 'dark' : 'light');
      localStorage.setItem('theme', on ? 'dark' : 'light');
    };
    setToggle(isDark);
    const toggleHandler = () => setToggle(!(toggle.dataset.on === 'true'));
    toggle.addEventListener('click', toggleHandler);
    toggle.addEventListener('keydown', (e)=>{ if(e.key===' '||e.key==='Enter'){ e.preventDefault(); toggleHandler(); }});

    // Logo & company (lazy/async)
    const logoSlot = document.getElementById('logoSlot');
    const aboutLogo = document.getElementById('aboutLogo');
    if (cfg.company?.logo) {
      const img = new Image();
      img.src = cfg.company.logo; img.className='logo'; img.alt=cfg.company.name||'Logo';
      img.loading = 'lazy'; img.decoding = 'async';
      logoSlot.replaceWith(img);
      aboutLogo.textContent = '';
      aboutLogo.style.backgroundImage = `url(${cfg.company.logo})`;
      aboutLogo.style.backgroundSize = 'cover';
      aboutLogo.style.backgroundPosition = 'center';
    } else {
      const abbr = (cfg.company?.name || 'LOGO').split(' ').map(w=>w[0]).join('').slice(0,3).toUpperCase();
      logoSlot.textContent = abbr;
      aboutLogo.textContent = abbr;
    }

    // Headline & tagline
    $('#jobTitle').textContent = cfg.job?.title || 'Fachkraft (m/w/d)';
    $('#companyPill').textContent = cfg.company?.tagline || cfg.company?.name || 'Handwerk im Saar‚ÄëPfalz‚ÄëRaum';

    // Footer links
    $('#companyNameFoot').textContent = cfg.company?.name || 'Dein Unternehmen';
    $('#privacyLink').href = cfg.legal?.privacy_url || '#';
    $('#imprintLink').href = cfg.legal?.imprint_url || '#';

    // About
    $('#aboutTitle').textContent = '√úber ' + (cfg.company?.name || 'uns');
    $('#aboutText').textContent = cfg.company?.about || '';

    // Benefits (emoji + desc)
    const list = $('#benefitsList');
    (cfg.benefits||[]).forEach(item => {
      const li = document.createElement('li'); li.className='benefit';
      const t = document.createElement('div'); t.className='benefit-title';
      const icon = document.createElement('span'); icon.textContent = item.icon || 'üîß';
      const txt = document.createElement('span'); txt.textContent = item.title || '';
      t.appendChild(icon); t.appendChild(txt);
      const d = document.createElement('div'); d.className='benefit-desc'; d.textContent = item.desc || '';
      li.appendChild(t); li.appendChild(d); list.appendChild(li);
    });

    // Accordion summary content
    const sTitle = cfg.summary?.title || 'Kurzinfo zur Stelle & Ablauf';
    $('#summaryTitle').textContent = sTitle;
    const body = $('#summaryBody');
    const mkGroup = (header, arr) => {
      if (!arr || !arr.length) return;
      const wrap = document.createElement('div');
      const h = document.createElement('div'); h.className='mini'; h.style.fontWeight='900'; h.textContent = header;
      wrap.appendChild(h);
      arr.forEach(line=>{
        const row = document.createElement('div'); row.className='bullet';
        const icon = document.createElement('i'); icon.textContent = '‚Ä¢';
        const text = document.createElement('div'); text.textContent = line;
        row.appendChild(icon); row.appendChild(text);
        wrap.appendChild(row);
      });
      body.appendChild(wrap);
    };
    mkGroup('Zur Stelle', cfg.summary?.aboutRole);
    mkGroup('Ablauf', cfg.summary?.process);

    // Progress bar
    const progressBar = $('#progressBar');
    const setProgress = (step) => { const pct = (step-1) / 3 * 100; progressBar.style.width = pct + '%'; };

    // Steps control
    let currentStep = 1;
    const showStep = (n) => {
      $$('.step').forEach(s => s.classList.add('hidden'));
      $(`.step[data-step="${n}"]`).classList.remove('hidden');
      currentStep = n; setProgress(n);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    // Mustache helper
    const mustache = (str, data) => str?.replace(/\{\{([^}]+)\}\}/g, (_, k) => k.trim().split('.').reduce((acc, key) => (acc && acc[key] != null) ? acc[key] : '', data));

    // Build questions
    const qHost = $('#questions');
    const buildQuestion = (q) => {
      const wrap = document.createElement('div'); wrap.className = 'grid'; wrap.dataset.qid = q.id;
      const label = document.createElement('h3'); label.style.marginBottom = '6px'; label.textContent = mustache(q.label, cfg); wrap.appendChild(label);

      if (q.type === 'yesno') {
        const row = document.createElement('div'); row.className = 'yn';
        ['Ja','Nein'].forEach(val => {
          const btn = document.createElement('button'); btn.type='button'; btn.className='chip'; btn.textContent=val;
          btn.addEventListener('click', ()=>{ row.querySelectorAll('.chip').forEach(c=>c.classList.remove('active')); btn.classList.add('active'); wrap.dataset.value = (val==='Ja'); });
          row.appendChild(btn);
        });
        wrap.appendChild(row);
      }
      else if (q.type === 'select') {
        const row = document.createElement('div'); row.className='seg';
        (q.options||[]).forEach(val => {
          const btn = document.createElement('button'); btn.type='button'; btn.className='chip'; btn.textContent=val;
          btn.addEventListener('click', ()=>{ row.querySelectorAll('.chip').forEach(c=>c.classList.remove('active')); btn.classList.add('active'); wrap.dataset.value = val; });
          row.appendChild(btn);
        });
        wrap.appendChild(row);
      }
      else { // text
        const fc = document.createElement('div'); fc.className='fcontrol';
        const inp = document.createElement('input'); inp.className='finput'; inp.type='text'; inp.placeholder=' ';
        const fl = document.createElement('label'); fl.className='flabel'; fl.textContent='Antwort eingeben';
        inp.addEventListener('input', ()=>{ wrap.dataset.value = inp.value.trim(); });
        fc.appendChild(inp); fc.appendChild(fl); wrap.appendChild(fc);
      }

      qHost.appendChild(wrap);
    };

    (cfg.questions || []).slice(0,4).forEach(buildQuestion);

    // State
    const state = { answers: {}, applicant: { name:'', phone:'', email:'' }, consent_gdpr: false };

    // Buttons
    $('#startBtn').addEventListener('click', ()=> showStep(2));

    $('#toContact').addEventListener('click', ()=>{
      const items = $$('#questions [data-qid]');
      let ok = true;
      items.forEach((node, idx) => {
        const q = (cfg.questions||[])[idx];
        const value = node.dataset.value;
        if (q?.required && (value === undefined || value === '')) ok = false;
        state.answers[q.id] = value ?? null;
      });
      if (!ok) { $('#qError').classList.remove('hidden'); return; } else { $('#qError').classList.add('hidden'); }
      showStep(3);
      // Autofokus auf Name-Feld nach Stepwechsel
      setTimeout(()=>{ const n = $('#name'); if (n) { n.focus(); } }, 60);
    });

    const validEmail = (e) => /.+@.+\..+/.test(e);
    const validPhone = (p) => /[0-9+()\s-]{6,}/.test(p);

    async function sendPayload(url, payload, attempts = 3) {
      let delay = 600; // ms
      for (let i = 0; i < attempts; i++) {
        try {
          const res = await fetch(url, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
          if (!res.ok) throw new Error('HTTP '+res.status);
          return res;
        } catch (e) {
          if (i === attempts - 1) throw e;
          await new Promise(r => setTimeout(r, delay));
          delay *= 2; // Exponential Backoff
        }
      }
    }

    $('#submitBtn').addEventListener('click', async ()=>{
      const name = $('#name').value.trim();
      const phone = $('#phone').value.trim();
      const email = $('#email').value.trim();
      const consent = $('#consent').checked;

      const ok = name && validPhone(phone) && validEmail(email) && consent;
      if (!ok) { $('#formError').classList.remove('hidden'); return; } else { $('#formError').classList.add('hidden'); }

      state.applicant = { name, phone, email };
      state.consent_gdpr = consent;

      // UTM & source
      const params = new URLSearchParams(location.search);
      const utm = Object.fromEntries(['utm_source','utm_medium','utm_campaign','utm_content','utm_term'].map(k=>[k, params.get(k)]) );
      const source = params.get('utm_source') || 'direct';

      const payload = {
        funnel_id: cfg.n8n?.funnel_id || 'handwerk-funnel-v4',
        job_title: cfg.job?.title || '',
        company_name: cfg.company?.name || '',
        answers: state.answers,
        applicant: state.applicant,
        consent_gdpr: state.consent_gdpr,
        source,
        utm,
        stage: 'new',
        locale: 'de-DE',
        timestamp: new Date().toISOString()
      };

      const btn = $('#submitBtn');
      btn.disabled = true; btn.textContent = 'Sende‚Ä¶';

      try {
        await sendPayload(cfg.n8n?.webhook_url || '', payload, 3);
        showStep(4);
      } catch(e) {
        $('#formError').classList.remove('hidden');
        $('#formError').textContent = '√úbertragung fehlgeschlagen. Bitte sp√§ter erneut versuchen.';
        btn.disabled = false; btn.textContent = 'Bewerbung absenden';
        return;
      }
    });

    $('#finishBtn').addEventListener('click', ()=>{ location.hash = '#start'; location.reload(); });

    // Init progress
    showStep(1);
  })();
  </script>
</body>
</html>
