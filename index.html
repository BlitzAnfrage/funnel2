<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b1120" />
  <title>Blitzanfrage – Neukunden (v7)</title>
  <!-- Inter Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700;800;900&display=swap" rel="stylesheet">
  <!--
  ==============================================================================
  BRIEFING-FUNNEL V7 – PC-optimiert, Dark only, AI-ready
  Änderung: Header vereinfacht – NUR Titel „Blitzanfrage – Neukunden“, zentriert & größer, KEIN Logo.
  ==============================================================================
  -->
  <style>
    :root{
      --bg:#0b1120; --surface:#0f172a; --card:#0f172a; --text:#e5e7eb; --muted:#9ca3af; --stroke: #1f2937;
      --primary:#62bb47; --accent:#3fb1ff; --ring: rgba(63,177,255,.35); --danger:#ef4444; --ok:#22c55e;
      --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.35); --maxw:1100px;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:radial-gradient(1200px 800px at 20% -10%,#182036,transparent), radial-gradient(1000px 600px at 120% 10%,#132036,transparent), var(--bg); color:var(--text)}

    .container{max-width:var(--maxw);margin:0 auto;padding:18px}

    /* Header (centered, no logo) */
    header.top{display:flex;align-items:center;justify-content:center;margin-bottom:10px}
    .hero-title{font-size:clamp(2rem,3.6vw,2.8rem);font-weight:900;letter-spacing:.2px;text-align:center;margin:0 auto;}

    /* Stepper */
    .stepper{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .step{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid #1f2a3c;border-radius:12px;background:#0f172a80;backdrop-filter: blur(6px); cursor:pointer; transition: transform .12s ease, border-color .2s}
    .step:hover{transform: translateY(-1px)}
    .step.active{outline:3px solid var(--ring)}
    .bub{width:26px;height:26px;border-radius:999px;border:1px solid #2a3650;display:grid;place-items:center;font-weight:900;background:linear-gradient(180deg,#121a2e,#0b1324)}
    .bub.ok{border-color: #1f6e3a; background: linear-gradient(180deg,#12301f,#0e2418)}

    /* Info bar (fixed process) */
    .infobar{max-width:880px;margin:10px auto 0; padding:10px 12px; border:1px dashed #243047; border-radius:12px; color:var(--muted); font-weight:700; background:#0b1222}

    /* Shell */
    .card{background:linear-gradient(180deg,#0f172a,#0b1223); border:1px solid #1f2a3c; border-radius:var(--radius); box-shadow:var(--shadow)}
    .inner{padding:18px}
    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:1fr 1fr}
    .g3{grid-template-columns:repeat(3,1fr)}
    @media (max-width: 920px){.g2,.g3{grid-template-columns:1fr}}

    .label{font-weight:800}
    .hint{font-size:.87rem;color:var(--muted)}
    .input, .textarea, select{width:100%;padding:12px 12px;border-radius:12px;border:1px solid #223049;background:#0b1222;color:var(--text);outline:none;font-size:15px; transition: box-shadow .2s, transform .06s}
    .input:focus,.textarea:focus,select:focus{outline:3px solid var(--ring);border-color:transparent; box-shadow: 0 0 0 3px var(--ring)}
    .textarea{min-height:96px}

    .filebox{border:1px dashed #2a3650;border-radius:12px;padding:12px;display:grid;gap:8px; background:#0b1222}
    .filebox input[type="file"]{display:block}

    .actions{display:flex;gap:8px;align-items:center}
    .spacer{flex:1}
    .btn{appearance:none;border:none;background:linear-gradient(90deg,var(--primary),var(--accent));color:#fff;padding:12px 14px;border-radius:12px;font-weight:900;cursor:pointer;box-shadow:var(--shadow);transition: transform .08s ease, filter .2s}
    .btn.secondary{background:transparent;border:1px solid #2a3650;color:var(--text)}
    .btn:active{transform: translateY(1px)}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .footer{display:flex;gap:8px;justify-content:flex-end;padding:14px;border-top:1px solid #1f2a3c}

    .row{display:grid;gap:6px}

    .repeat-list{display:grid;gap:10px}
    .repeat-item{border:1px dashed #26324b;border-radius:12px;padding:12px;background:#0b1222}

    /* Animations */
    .fade{opacity:0; transform: translateY(6px); animation: in .25s ease forwards}
    @keyframes in{to{opacity:1; transform: translateY(0)}}

    /* Toast */
    .toast{position:fixed; right:18px; bottom:18px; background:#0b1222; border:1px solid #243047; color:var(--text); padding:12px 14px; border-radius:12px; box-shadow:var(--shadow); display:none}
    .toast.show{display:block}
  </style>
</head>
<body>
  <div class="container">
    <header class="top">
      <h1 class="hero-title">Blitzanfrage – Neukunden</h1>
    </header>

    <div class="card">
      <div class="inner">
        <div class="stepper" id="stepper"></div>
        <div class="infobar">Ablauf: 60 Sek. Formular → Rückruf (≤24h Werktag) → Vorstellungsgespräch</div>
      </div>
      <div class="inner" id="formHost"></div>
      <div class="footer">
        <button class="btn secondary" id="prevBtn">Zurück</button>
        <div class="spacer"></div>
        <button class="btn secondary" id="saveBtn">Zwischenspeichern</button>
        <button class="btn" id="nextBtn">Weiter</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
  (()=>{
    const TEST_WEBHOOK_URL = "https://n8n.srv899952.hstgr.cloud/webhook-test/funnel"; // TODO: hier deine Test-Webhook-URL einsetzen

    // Helpers
    const $ = (s,r=document)=>r.querySelector(s);
    const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
    const toast = (msg, ok=false)=>{ const t=$('#toast'); t.textContent=msg; t.style.borderColor= ok?'#1f6e3a':'#243047'; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2200)}

    // Accent automatisch aus Primärfarbe ableiten
    function hexToHsl(hex){ hex=hex.replace('#',''); if(hex.length===3){hex=hex.split('').map(x=>x+x).join('')} const r=parseInt(hex.substring(0,2),16)/255, g=parseInt(hex.substring(2,4),16)/255, b=parseInt(hex.substring(4,6),16)/255; const max=Math.max(r,g,b), min=Math.min(r,g,b); let h,s,l=(max+min)/2; if(max===min){h=s=0}else{const d=max-min; s=l>0.5? d/(2-max-min): d/(max+min); switch(max){case r: h=(g-b)/d+(g<b?6:0); break; case g: h=(b-r)/d+2; break; case b: h=(r-g)/d+4; break;} h/=6;} return [Math.round(h*360), Math.round(s*100), Math.round(l*100)]; }
    function hslToHex(h,s,l){ s/=100; l/=100; const k=n=>(n+ h/30)%12; const a=s*Math.min(l,1-l); const f=n=>{ const c=l-a*Math.max(-1, Math.min(k(n)-3, Math.min(9-k(n),1))); return Math.round(255*c).toString(16).padStart(2,'0') }; return `#${f(0)}${f(8)}${f(4)}` }
    function autoAccent(primary){ const [h,s,l]=hexToHsl(primary||'#62bb47'); const h2=(h+35)%360; const s2=Math.min(100, s+10); const l2=Math.min(95, l+10); return hslToHex(h2,s2,l2); }

    // Steps (ohne „Ablauf“)
    const steps=[
      {id:'firm', name:'Firma', req:true},
      {id:'job', name:'Stelle', req:true},
      {id:'benefits', name:'Vorteile', req:false},
      {id:'design', name:'Design', req:true},
      {id:'questions', name:'Fragen', req:true},
      {id:'legal', name:'Recht', req:true},
      {id:'submit', name:'Absenden', req:true}
    ];

    let current=0; const state = JSON.parse(localStorage.getItem('bf_v7')||'{}');

    // Prefills (einmalig)
    if(!state._bootstrapped){
      state.company = { name:'', region:'Saarland / Pfalz', website:'', logo_url:'', about_generate:true };
      state.job = { title:'', alias:'' };
      state.benefits = [
        {icon:'💶', title:'Übertarifliche Bezahlung', desc:'Leistungsgerecht und pünktlich.'},
        {icon:'🏠', title:'Regionale Einsätze', desc:'Abends zu Hause, keine Fernmontage.'},
        {icon:'🚐', title:'Moderner Fuhrpark', desc:'Saubere Fahrzeuge & gutes Werkzeug.'},
        {icon:'📅', title:'Feste Arbeitszeiten', desc:'Planbare Touren & kurze Wege.'},
        {icon:'🎓', title:'Weiterbildung', desc:'Schulungen & Aufstiegschancen.'}
      ];
      state.theme = { primary:'#62bb47' };
      state.questions = [
        {label:'Hast du bereits Erfahrungen als {{job.alias}}?', type:'yesno', required:true},
        {label:'Wie viele Jahre Berufserfahrung hast du?', type:'select', required:true, options:'0–1, 2–4, 5+'},
        {label:'Hast du einen PKW‑Führerschein (Klasse B)?', type:'yesno', required:true}
      ];
      state.legal = { privacy_url:'', imprint_url:'' };
      state._bootstrapped = true;
    }

    // UI
    const stepper = $('#stepper'); const host = $('#formHost');
    function isValidFirm(){ return !!(state.company && state.company.name && state.company.region); }
    function isValidJob(){ return !!(state.job && state.job.title && state.job.alias); }
    function isValidBenefits(){ return (state.benefits||[]).length>=3; }
    function isValidDesign(){ return !!(state.theme && state.theme.primary); }
    function isValidQuestions(){ const q=state.questions||[]; return q.length>=3 && q.length<=4 && q.every(x=>x.label && x.type); }
    function isValidLegal(){ return !!(state.legal && state.legal.privacy_url && state.legal.imprint_url); }

    const validators = { firm:isValidFirm, job:isValidJob, benefits:isValidBenefits, design:isValidDesign, questions:isValidQuestions, legal:isValidLegal, submit:()=>true };

    function renderStepper(){ stepper.innerHTML=''; steps.forEach((s,idx)=>{ const ok = validators[s.id](); const el=document.createElement('div'); el.className='step'+(idx===current?' active':''); el.innerHTML=`<div class="bub ${ok?'ok':''}">${ok?'✔':idx+1}</div><div>${s.name}</div>`; el.addEventListener('click',()=>{ save(false); current=idx; render(); }); stepper.appendChild(el); }); }

    function inputRow(id,label,ph,value,cb, type='text'){
      const wrap=document.createElement('div'); wrap.className='row fade'; wrap.innerHTML=`<label class="label" for="${id}">${label}</label><input class="input" id="${id}" placeholder="${ph||''}" ${type!=='text'?`type="${type}"`:''} />`;
      const inp=wrap.querySelector('input'); inp.value=value||''; inp.addEventListener('input',e=>cb(e.target.value)); return wrap;
    }

    function renderFirm(){
      host.innerHTML=''; const g=document.createElement('div'); g.className='grid g2';
      g.appendChild(inputRow('cname','Firmenname *','Muster Bau GmbH', state.company?.name, v=>{state.company.name=v; updateTheme(); }));
      g.appendChild(inputRow('creg','Region *','Saarland / Pfalz', state.company?.region, v=>{state.company.region=v;}));

      const web=document.createElement('div'); web.className='row fade'; web.innerHTML=`<label class="label" for="cweb">Website</label><input class="input" id="cweb" placeholder="https://…" /><div class="hint">"Über uns" wird automatisch aus der Website/Preset vom Prompt erstellt.</div>`; web.querySelector('input').value=state.company?.website||''; web.querySelector('input').addEventListener('input',e=>{state.company.website=e.target.value});

      const logoUrl=document.createElement('div'); logoUrl.className='row fade'; logoUrl.innerHTML=`<label class="label" for="clogo">Logo‑URL</label><input class="input" id="clogo" placeholder="https://…/logo.png" />`; logoUrl.querySelector('input').value=state.company?.logo_url||''; logoUrl.querySelector('input').addEventListener('input',e=>{state.company.logo_url=e.target.value});

      const fileBox=document.createElement('div'); fileBox.className='filebox fade'; fileBox.innerHTML=`<div class="label">Oder Logo hochladen</div><input id="clogofile" type="file" accept="image/*" /><div class="hint">PNG/SVG/JPG – wird als Data‑URL gespeichert</div>`; fileBox.querySelector('input').addEventListener('change',e=>{ const f=e.target.files?.[0]; if(!f) return; const fr=new FileReader(); fr.onload=()=>{ state.company.logo_data_url = fr.result; toast('Logo geladen', true); renderLogoPreview(); }; fr.readAsDataURL(f); });

      const preview=document.createElement('div'); preview.className='row fade'; preview.innerHTML=`<div class="hint">Logo‑Vorschau</div><div id="logoPrev" style="height:56px;display:flex;align-items:center;gap:10px"></div>`;

      function renderLogoPreview(){ const box=preview.querySelector('#logoPrev'); box.innerHTML=''; if(state.company.logo_data_url){ const img=new Image(); img.src=state.company.logo_data_url; img.style.height='56px'; img.style.borderRadius='10px'; img.style.border='1px solid #243047'; box.appendChild(img); } else if(state.company.logo_url){ const img=new Image(); img.src=state.company.logo_url; img.style.height='56px'; img.style.borderRadius='10px'; img.style.border='1px solid #243047'; box.appendChild(img); } else { box.textContent='(kein Logo)'; }
      }

      g.appendChild(web); g.appendChild(logoUrl); g.appendChild(fileBox); g.appendChild(preview);
      host.appendChild(g); renderLogoPreview();
    }

    function renderJob(){
      host.innerHTML=''; const g=document.createElement('div'); g.className='grid g2';
      g.appendChild(inputRow('jtitle','Jobtitel *','Anlagenmechaniker SHK (m/w/d)', state.job?.title, v=>state.job.title=v));
      g.appendChild(inputRow('jalias','Alias / Kurzform *','SHK‑Anlagenmechaniker', state.job?.alias, v=>state.job.alias=v));
      const notes=inputRow('jnotes','Besonderheiten (optional)','z. B. Vollzeit, keine Montage', state.job?.notes||'', v=>state.job.notes=v);
      notes.classList.add('fade'); g.appendChild(notes); host.appendChild(g);
    }

    function renderBenefits(){
      host.innerHTML=''; const list=document.createElement('div'); list.className='repeat-list';
      const bar=document.createElement('div'); bar.className='actions fade'; bar.innerHTML=`<button class="btn secondary" id="addB">+ Vorteil</button><div class="hint">5 sind bereits eingetragen – einfach anpassen oder löschen.</div>`; host.appendChild(bar);
      $('#addB', bar).addEventListener('click',()=>{ (state.benefits=state.benefits||[]).push({icon:'🔧',title:'',desc:''}); renderBenefits(); });

      (state.benefits||[]).forEach((b,i)=>{
        const row=document.createElement('div'); row.className='repeat-item fade'; row.innerHTML=`
          <div class="grid g3">
            <div class="row"><label class="label">Emoji</label><input class="input" value="${b.icon||''}"></div>
            <div class="row"><label class="label">Titel</label><input class="input" value="${b.title||''}"></div>
            <div class="row"><label class="label">Kurztext</label><input class="input" value="${b.desc||''}"></div>
          </div>
          <div class="actions" style="justify-content:flex-end;margin-top:8px"><button class="btn secondary" data-del>Entfernen</button></div>`;
        const [iEmoji,iTitle,iDesc]=row.querySelectorAll('input'); iEmoji.addEventListener('input',e=>{b.icon=e.target.value; save(false)}); iTitle.addEventListener('input',e=>{b.title=e.target.value; save(false)}); iDesc.addEventListener('input',e=>{b.desc=e.target.value; save(false)});
        row.querySelector('[data-del]').addEventListener('click',()=>{ state.benefits.splice(i,1); renderBenefits(); }); list.appendChild(row);
      });
      host.appendChild(list);
    }

    function renderDesign(){
      host.innerHTML=''; const g=document.createElement('div'); g.className='grid g2';
      const primaryRow=inputRow('prim','Hauptfarbe','#62bb47', state.theme?.primary||'#62bb47', v=>{ state.theme.primary=v; document.documentElement.style.setProperty('--primary', v); const acc=autoAccent(v); document.documentElement.style.setProperty('--accent', acc); }); primaryRow.querySelector('input').type='color';
      const heroBox=document.createElement('div'); heroBox.className='filebox fade'; heroBox.innerHTML=`<div class="label">Optional: Hero‑Bild hochladen</div><input id="herofile" type="file" accept="image/*" /><div class="hint">Wird als Data‑URL gespeichert (für Prompt oder späteren Upload)</div>`; heroBox.querySelector('input').addEventListener('change',e=>{ const f=e.target.files?.[0]; if(!f) return; const fr=new FileReader(); fr.onload=()=>{ state.design = state.design||{}; state.design.hero_data_url = fr.result; toast('Hero geladen', true); }; fr.readAsDataURL(f); });
      g.appendChild(primaryRow); g.appendChild(heroBox); host.appendChild(g);
    }

    function renderQuestions(){
      host.innerHTML=''; const list=document.createElement('div'); list.className='repeat-list';
      const bar=document.createElement('div'); bar.className='actions fade'; bar.innerHTML=`<button class="btn secondary" id="addQ">+ Frage</button><div class="hint">3 Standardfragen sind eingetragen. Max. 4 gesamt.</div>`; host.appendChild(bar); $('#addQ',bar).addEventListener('click',()=>{ (state.questions=state.questions||[]).push({label:'',type:'text',required:false}); renderQuestions(); });
      (state.questions||[]).slice(0,4).forEach((q,i)=>{
        const row=document.createElement('div'); row.className='repeat-item fade'; row.innerHTML=`
          <div class="grid g3">
            <div class="row"><label class="label">Frage</label><input class="input" value="${q.label||''}" placeholder="Hast du…?"></div>
            <div class="row"><label class="label">Typ</label><select class="input"><option value="yesno">yesno</option><option value="select">select</option><option value="text">text</option></select></div>
            <div class="row"><label class="label">Pflicht</label><select class="input"><option value="true">ja</option><option value="false">nein</option></select></div>
          </div>
          <div class="row"><label class="label">Optionen (bei select, Komma‑getrennt)</label><input class="input" value="${q.options||''}" placeholder="0–1, 2–4, 5+"></div>
          <div class="actions" style="justify-content:flex-end"><button class="btn secondary" data-del>Entfernen</button></div>`;
        const sels=row.querySelectorAll('select'); sels[0].value=q.type||'yesno'; sels[0].addEventListener('change',e=>{ q.type=e.target.value; save(false)}); sels[1].value=q.required?'true':'false'; sels[1].addEventListener('change',e=>{ q.required=e.target.value==='true'; save(false)});
        const [lbl,opt]=row.querySelectorAll('input'); lbl.addEventListener('input',e=>{ q.label=e.target.value; save(false)}); opt.addEventListener('input',e=>{ q.options=e.target.value; save(false)});
        row.querySelector('[data-del]').addEventListener('click',()=>{ state.questions.splice(i,1); renderQuestions(); }); list.appendChild(row);
      }); host.appendChild(list);
    }

    function renderLegal(){
      host.innerHTML=''; const g=document.createElement('div'); g.className='grid g2';
      g.appendChild(inputRow('priv','Datenschutz‑Link *','https://…/datenschutz', state.legal?.privacy_url, v=>{state.legal.privacy_url=v}));
      g.appendChild(inputRow('imp','Impressum‑Link *','https://…/impressum', state.legal?.imprint_url, v=>{state.legal.imprint_url=v}));
      const note=document.createElement('div'); note.className='hint fade'; note.textContent='Hinweis: DSGVO wird im Prompt/Output berücksichtigt.'; host.appendChild(g); host.appendChild(note);
    }

    function renderSubmit(){
      host.innerHTML=''; const box=document.createElement('div'); box.className='grid';
      const info=document.createElement('div'); info.className='hint'; info.innerHTML='Bereit? Beim Absenden werden deine Angaben <strong>an den Test‑Webhook</strong> gesendet.';
      const row=document.createElement('div'); row.className='actions'; row.innerHTML='<div class="spacer"></div><button class="btn" id="sendBtn">Absenden</button>';
      box.appendChild(info); box.appendChild(row); host.appendChild(box);
      $('#sendBtn').addEventListener('click', sendNow);
    }

    function render(){ renderStepper(); const id=steps[current].id; const map={firm:renderFirm, job:renderJob, benefits:renderBenefits, design:renderDesign, questions:renderQuestions, legal:renderLegal, submit:renderSubmit}; map[id](); updateTheme(); }

    function save(show=true){ localStorage.setItem('bf_v7', JSON.stringify(state)); if(show) toast('Gespeichert', true); renderStepper(); }

    // Navigation
    $('#prevBtn').addEventListener('click',()=>{ if(current>0){ save(false); current--; render(); }});
    $('#nextBtn').addEventListener('click',()=>{ const id=steps[current].id; if(validators[id] && !validators[id]()){ toast('Bitte Pflichtfelder ausfüllen', false); return; } save(false); if(current<steps.length-1){ current++; render(); }});
    $('#saveBtn').addEventListener('click',()=>save());

    function buildPayload(){
      const params = new URLSearchParams(location.search);
      const utm = Object.fromEntries(['utm_source','utm_medium','utm_campaign','utm_content','utm_term'].map(k=>[k, params.get(k)]) );
      return {
        funnel_id: (state.company?.name||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-|-$|/g,'' ) + '-' + (state.job?.alias||'').toLowerCase().replace(/[^a-z0-9]+/g,'-'),
        company: {
          name: state.company?.name||'',
          region: state.company?.region||'',
          website: state.company?.website||'',
          logo_url: state.company?.logo_url||'',
          logo_data_url: state.company?.logo_data_url||'',
          about_generate: true
        },
        job: { title: state.job?.title||'', alias: state.job?.alias||'', notes: state.job?.notes||'' },
        benefits: state.benefits||[],
        process: { steps:[ '1) 60 Sek. Formular', '2) Rückruf (≤24h Werktag)', '3) Vorstellungsgespräch' ] },
        theme: { primary: state.theme?.primary||'#62bb47', accent_auto: true },
        questions: (state.questions||[]).slice(0,4),
        legal: { privacy_url: state.legal?.privacy_url||'', imprint_url: state.legal?.imprint_url||'' },
        design: { hero_data_url: state?.design?.hero_data_url||'' },
        ai_flags: { generate_about:true, generate_benefits:false, auto_accent:true, auto_hero:false },
        meta: { source: params.get('utm_source')||'direct', utm }
      };
    }

    async function postWithRetry(url, payload, attempts=3){ let delay=600; for(let i=0;i<attempts;i++){ try{ const res=await fetch(url,{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)}); if(!res.ok) throw new Error('HTTP '+res.status); return await res.text(); } catch(e){ if(i===attempts-1) throw e; await new Promise(r=>setTimeout(r,delay)); delay*=2; } } }

    async function sendNow(){ const payload=buildPayload(); $('#nextBtn').disabled=true; try{ await postWithRetry(TEST_WEBHOOK_URL, payload, 3); toast('Erfolgreich gesendet ✔', true); } catch(e){ toast('Senden fehlgeschlagen. Prüfe Webhook.', false);} finally{ $('#nextBtn').disabled=false; } }

    function updateTheme(){ // update accent from primary
      const p = state.theme?.primary||'#62bb47'; document.documentElement.style.setProperty('--primary', p); const acc=autoAccent(p); document.documentElement.style.setProperty('--accent', acc);
    }

    // init
    render();
  })();
  </script>
</body>
</html>